diff -urN linux-2.6.12-rc6/arch/i386/Kconfig linux-2.6.12-rc6-pcsp-kern/arch/i386/Kconfig
--- linux-2.6.12-rc6/arch/i386/Kconfig	2005-06-07 11:11:37.000000000 +0400
+++ linux-2.6.12-rc6-pcsp-kern/arch/i386/Kconfig	2005-06-07 11:18:33.000000000 +0400
@@ -1287,3 +1287,8 @@
 	bool
 	depends on X86 && !EMBEDDED
 	default y
+
+config HAVE_PCSP_HOOK
+	bool
+	depends on X86_PC
+	default y
diff -urN linux-2.6.12-rc6/arch/i386/kernel/time.c linux-2.6.12-rc6-pcsp-kern/arch/i386/kernel/time.c
--- linux-2.6.12-rc6/arch/i386/kernel/time.c	2005-06-07 11:11:34.000000000 +0400
+++ linux-2.6.12-rc6-pcsp-kern/arch/i386/kernel/time.c	2005-06-07 11:18:33.000000000 +0400
@@ -77,6 +77,9 @@
 
 EXPORT_SYMBOL(jiffies_64);
 
+volatile int pit_counter0_offset = 0;
+EXPORT_SYMBOL(pit_counter0_offset);
+
 unsigned long cpu_khz;	/* Detected as we calibrate the TSC */
 
 extern unsigned long wall_jiffies;
diff -urN linux-2.6.12-rc6/arch/i386/kernel/timers/timer_pit.c linux-2.6.12-rc6-pcsp-kern/arch/i386/kernel/timers/timer_pit.c
--- linux-2.6.12-rc6/arch/i386/kernel/timers/timer_pit.c	2005-06-07 11:11:34.000000000 +0400
+++ linux-2.6.12-rc6-pcsp-kern/arch/i386/kernel/timers/timer_pit.c	2005-06-07 11:18:33.000000000 +0400
@@ -139,6 +139,12 @@
 	} else
 		jiffies_p = jiffies_t;
 
+       /*
+        * when using PCSP, we must add the accumulated
+        * clockticks from the PCSP driver
+        */
+	count += pit_counter0_offset;
+
 	count_p = count;
 
 	spin_unlock_irqrestore(&i8253_lock, flags);
diff -urN linux-2.6.12-rc6/arch/i386/mach-default/setup.c linux-2.6.12-rc6-pcsp-kern/arch/i386/mach-default/setup.c
--- linux-2.6.12-rc6/arch/i386/mach-default/setup.c	2005-06-07 11:11:32.000000000 +0400
+++ linux-2.6.12-rc6-pcsp-kern/arch/i386/mach-default/setup.c	2005-06-07 11:18:33.000000000 +0400
@@ -71,7 +71,7 @@
 {
 }
 
-static struct irqaction irq0  = { timer_interrupt, SA_INTERRUPT, CPU_MASK_NONE, "timer", NULL, NULL};
+static struct irqaction irq0  = { timer_interrupt, SA_INTERRUPT | SA_SHIRQ, CPU_MASK_NONE, "timer", NULL, NULL};
 
 /**
  * time_init_hook - do any specific initialisations for the system timer.
diff -urN linux-2.6.12-rc6/arch/i386/mach-visws/setup.c linux-2.6.12-rc6-pcsp-kern/arch/i386/mach-visws/setup.c
--- linux-2.6.12-rc6/arch/i386/mach-visws/setup.c	2005-06-07 11:11:37.000000000 +0400
+++ linux-2.6.12-rc6-pcsp-kern/arch/i386/mach-visws/setup.c	2005-06-07 11:18:33.000000000 +0400
@@ -112,7 +112,7 @@
 
 static struct irqaction irq0 = {
 	.handler =	timer_interrupt,
-	.flags =	SA_INTERRUPT,
+	.flags =	SA_INTERRUPT | SA_SHIRQ,
 	.name =		"timer",
 };
 
diff -urN linux-2.6.12-rc6/arch/i386/mach-voyager/setup.c linux-2.6.12-rc6-pcsp-kern/arch/i386/mach-voyager/setup.c
--- linux-2.6.12-rc6/arch/i386/mach-voyager/setup.c	2005-06-07 11:11:31.000000000 +0400
+++ linux-2.6.12-rc6-pcsp-kern/arch/i386/mach-voyager/setup.c	2005-06-07 11:18:33.000000000 +0400
@@ -40,7 +40,7 @@
 {
 }
 
-static struct irqaction irq0  = { timer_interrupt, SA_INTERRUPT, CPU_MASK_NONE, "timer", NULL, NULL};
+static struct irqaction irq0  = { timer_interrupt, SA_INTERRUPT | SA_SHIRQ, CPU_MASK_NONE, "timer", NULL, NULL};
 
 void __init time_init_hook(void)
 {
diff -urN linux-2.6.12-rc6/CREDITS linux-2.6.12-rc6-pcsp-kern/CREDITS
--- linux-2.6.12-rc6/CREDITS	2005-06-07 11:11:40.000000000 +0400
+++ linux-2.6.12-rc6-pcsp-kern/CREDITS	2005-06-07 13:27:04.000000000 +0400
@@ -391,6 +391,8 @@
 N: Erik Inge Bolsø
 E: knan@mo.himolde.no
 D: Misc kernel hacks
+D: Updated PC speaker driver for 2.3
+S: Norway
 
 N: Andreas E. Bombe
 E: andreas.bombe@munich.netsurf.de
@@ -3017,6 +3019,12 @@
 S: Sunnyvale, California 94088-4132
 S: USA
 
+N: Stas Sergeev
+E: stsp@users.sourceforge.net
+D: PC-Speaker driver maintainer
+D: misc fixes and improvements
+S: Russia
+
 N: Simon Shapiro
 E: shimon@i-Connect.Net
 W: http://www.-i-Connect.Net/~shimon
diff -urN linux-2.6.12-rc6/drivers/input/gameport/gameport.c linux-2.6.12-rc6-pcsp-kern/drivers/input/gameport/gameport.c
--- linux-2.6.12-rc6/drivers/input/gameport/gameport.c	2005-06-07 11:11:49.000000000 +0400
+++ linux-2.6.12-rc6-pcsp-kern/drivers/input/gameport/gameport.c	2005-06-07 11:18:33.000000000 +0400
@@ -74,6 +74,7 @@
 	outb_p(0x00, 0x43);
 	count = inb_p(0x40);
 	count |= inb_p(0x40) << 8;
+	count += pit_counter0_offset;
 	spin_unlock_irqrestore(&i8253_lock, flags);
 
 	return count;
diff -urN linux-2.6.12-rc6/drivers/input/joystick/analog.c linux-2.6.12-rc6-pcsp-kern/drivers/input/joystick/analog.c
--- linux-2.6.12-rc6/drivers/input/joystick/analog.c	2005-06-07 11:11:49.000000000 +0400
+++ linux-2.6.12-rc6-pcsp-kern/drivers/input/joystick/analog.c	2005-06-07 11:18:33.000000000 +0400
@@ -153,6 +153,7 @@
         outb_p(0x00, 0x43);
         count = inb_p(0x40);
         count |= inb_p(0x40) << 8;
+        count += pit_counter0_offset;
         spin_unlock_irqrestore(&i8253_lock, flags);
 
         return count;
diff -urN linux-2.6.12-rc6/drivers/input/misc/pcspkr.c linux-2.6.12-rc6-pcsp-kern/drivers/input/misc/pcspkr.c
--- linux-2.6.12-rc6/drivers/input/misc/pcspkr.c	2005-06-07 11:11:49.000000000 +0400
+++ linux-2.6.12-rc6-pcsp-kern/drivers/input/misc/pcspkr.c	2005-06-07 11:18:33.000000000 +0400
@@ -16,6 +16,7 @@
 #include <linux/module.h>
 #include <linux/init.h>
 #include <linux/input.h>
+#include <linux/kd.h>
 #include <asm/8253pit.h>
 #include <asm/io.h>
 
@@ -26,6 +27,7 @@
 static char pcspkr_name[] = "PC Speaker";
 static char pcspkr_phys[] = "isa0061/input0";
 static struct input_dev pcspkr_dev;
+int volatile use_speaker_beep;
 
 static DEFINE_SPINLOCK(i8253_beep_lock);
 
@@ -37,6 +39,10 @@
 	if (type != EV_SND)
 		return -1;
 
+	/* pcsp audio driver can set this */
+	if (!use_speaker_beep)
+		return -1;
+
 	switch (code) {
 		case SND_BELL: if (value) value = 1000;
 		case SND_TONE: break;
@@ -81,6 +87,8 @@
 
 	input_register_device(&pcspkr_dev);
 
+	use_speaker_beep = 1;
+
         printk(KERN_INFO "input: %s\n", pcspkr_name);
 
 	return 0;
@@ -95,3 +103,5 @@
 
 module_init(pcspkr_init);
 module_exit(pcspkr_exit);
+
+EXPORT_SYMBOL(use_speaker_beep);
diff -urN linux-2.6.12-rc6/include/asm-i386/timex.h linux-2.6.12-rc6-pcsp-kern/include/asm-i386/timex.h
--- linux-2.6.12-rc6/include/asm-i386/timex.h	2005-06-07 11:12:31.000000000 +0400
+++ linux-2.6.12-rc6-pcsp-kern/include/asm-i386/timex.h	2005-06-07 11:18:33.000000000 +0400
@@ -49,4 +49,6 @@
 
 extern unsigned long cpu_khz;
 
+extern volatile int pit_counter0_offset;
+
 #endif
diff -urN linux-2.6.12-rc6/include/linux/interrupt.h linux-2.6.12-rc6-pcsp-kern/include/linux/interrupt.h
--- linux-2.6.12-rc6/include/linux/interrupt.h	2005-06-07 11:12:29.000000000 +0400
+++ linux-2.6.12-rc6-pcsp-kern/include/linux/interrupt.h	2005-06-07 11:18:33.000000000 +0400
@@ -31,6 +31,7 @@
 
 #define IRQ_NONE	(0)
 #define IRQ_HANDLED	(1)
+#define IRQ_DONE	(2)
 #define IRQ_RETVAL(x)	((x) != 0)
 
 struct irqaction {
diff -urN linux-2.6.12-rc6/include/linux/kd.h linux-2.6.12-rc6-pcsp-kern/include/linux/kd.h
--- linux-2.6.12-rc6/include/linux/kd.h	2005-06-07 11:12:29.000000000 +0400
+++ linux-2.6.12-rc6-pcsp-kern/include/linux/kd.h	2005-06-07 11:18:33.000000000 +0400
@@ -23,6 +23,7 @@
 
 #define KIOCSOUND	0x4B2F	/* start sound generation (0 for off) */
 #define KDMKTONE	0x4B30	/* generate tone */
+extern volatile int use_speaker_beep;
 
 #define KDGETLED	0x4B31	/* return current led state */
 #define KDSETLED	0x4B32	/* set led state [lights, not flags] */
diff -urN linux-2.6.12-rc6/include/linux/signal.h linux-2.6.12-rc6-pcsp-kern/include/linux/signal.h
--- linux-2.6.12-rc6/include/linux/signal.h	2005-06-07 11:12:30.000000000 +0400
+++ linux-2.6.12-rc6-pcsp-kern/include/linux/signal.h	2005-06-07 11:20:18.000000000 +0400
@@ -18,6 +18,7 @@
 #define SA_PROBE		SA_ONESHOT
 #define SA_SAMPLE_RANDOM	SA_RESTART
 #define SA_SHIRQ		0x04000000
+#define SA_FIRST		0x02000000
 
 /*
  * Real Time signals may be queued.
diff -urN linux-2.6.12-rc6/kernel/irq/handle.c linux-2.6.12-rc6-pcsp-kern/kernel/irq/handle.c
--- linux-2.6.12-rc6/kernel/irq/handle.c	2005-06-07 11:11:26.000000000 +0400
+++ linux-2.6.12-rc6-pcsp-kern/kernel/irq/handle.c	2005-06-07 11:18:33.000000000 +0400
@@ -86,11 +86,11 @@
 
 	do {
 		ret = action->handler(irq, action->dev_id, regs);
-		if (ret == IRQ_HANDLED)
+		if (ret & IRQ_HANDLED)
 			status |= action->flags;
 		retval |= ret;
 		action = action->next;
-	} while (action);
+	} while (action && !(retval & IRQ_DONE));
 
 	if (status & SA_SAMPLE_RANDOM)
 		add_interrupt_randomness(irq);
diff -urN linux-2.6.12-rc6/kernel/irq/manage.c linux-2.6.12-rc6-pcsp-kern/kernel/irq/manage.c
--- linux-2.6.12-rc6/kernel/irq/manage.c	2005-06-07 11:11:26.000000000 +0400
+++ linux-2.6.12-rc6-pcsp-kern/kernel/irq/manage.c	2005-06-07 11:18:33.000000000 +0400
@@ -188,11 +188,16 @@
 			return -EBUSY;
 		}
 
-		/* add new interrupt at end of irq queue */
-		do {
-			p = &old->next;
-			old = *p;
-		} while (old);
+		if (!(new->flags & SA_FIRST)) {
+			/* add new interrupt at end of irq queue */
+			do {
+				p = &old->next;
+				old = *p;
+			} while (old);
+		} else {
+			/* add new interrupt at front of irq queue */
+			new->next = old;
+		}
 		shared = 1;
 	}
 
diff -urN linux-2.6.12-rc6/kernel/irq/spurious.c linux-2.6.12-rc6-pcsp-kern/kernel/irq/spurious.c
--- linux-2.6.12-rc6/kernel/irq/spurious.c	2005-06-07 11:11:26.000000000 +0400
+++ linux-2.6.12-rc6-pcsp-kern/kernel/irq/spurious.c	2005-06-07 11:18:33.000000000 +0400
@@ -27,7 +27,7 @@
 {
 	struct irqaction *action;
 
-	if (action_ret != IRQ_HANDLED && action_ret != IRQ_NONE) {
+	if (!(action_ret & IRQ_HANDLED) && action_ret != IRQ_NONE) {
 		printk(KERN_ERR "irq event %d: bogus return value %x\n",
 				irq, action_ret);
 	} else {
@@ -57,7 +57,7 @@
 
 void note_interrupt(unsigned int irq, irq_desc_t *desc, irqreturn_t action_ret)
 {
-	if (action_ret != IRQ_HANDLED) {
+	if (!(action_ret & IRQ_HANDLED)) {
 		desc->irqs_unhandled++;
 		if (action_ret != IRQ_NONE)
 			report_bad_irq(irq, desc, action_ret);
