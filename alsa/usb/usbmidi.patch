--- ../alsa-kernel/usb/usbmidi.c	2009-07-15 12:04:09.000000000 +0200
+++ usbmidi.c	2009-07-16 12:03:08.000000000 +0200
@@ -1,3 +1,5 @@
+#include "usbmidi.inc"
+
 /*
  * usbmidi.c - ALSA USB MIDI driver
  *
@@ -235,7 +237,11 @@
 /*
  * Processes the data read from the device.
  */
+#if !defined(OLD_USB) && !defined(CONFIG_SND_NEW_IRQ_HANDLER)
+static void snd_usbmidi_in_urb_complete(struct urb* urb, struct pt_regs *regs)
+#else
 static void snd_usbmidi_in_urb_complete(struct urb* urb)
+#endif
 {
 	struct snd_usb_midi_in_endpoint* ep = urb->context;
 
@@ -255,11 +261,20 @@
 		}
 	}
 
+#if LINUX_VERSION_CODE < KERNEL_VERSION(2, 5, 45)
+	if (!usb_pipeint(urb->pipe))
+#endif
+	{
 	urb->dev = ep->umidi->chip->dev;
 	snd_usbmidi_submit_urb(urb, GFP_ATOMIC);
+	}
 }
 
+#if !defined(OLD_USB) && !defined(CONFIG_SND_NEW_IRQ_HANDLER)
+static void snd_usbmidi_out_urb_complete(struct urb* urb, struct pt_regs *regs)
+#else
 static void snd_usbmidi_out_urb_complete(struct urb* urb)
+#endif
 {
 	struct out_urb_context *context = urb->context;
 	struct snd_usb_midi_out_endpoint* ep = context->ep;
@@ -369,8 +384,13 @@
 		return -ENOMEM;
 	dump_urb("sending", buf, len);
 	if (ep->urbs[0].urb)
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(2, 6, 12)
 		err = usb_bulk_msg(ep->umidi->chip->dev, ep->urbs[0].urb->pipe,
 				   buf, len, NULL, 250);
+#else
+		err = usb_bulk_msg(ep->umidi->chip->dev, ep->urbs[0].urb->pipe,
+				   buf, len, NULL, HZ);
+#endif
 	kfree(buf);
 	return err;
 }
@@ -1582,7 +1602,11 @@
 	intf = umidi->iface;
 	if (!intf || intf->num_altsetting < 1)
 		return -ENOENT;
+#ifndef OLD_USB
 	hostif = intf->cur_altsetting;
+#else
+	hostif = &intf->altsetting[intf->act_altsetting];
+#endif
 	intfd = get_iface_desc(hostif);
 
 	for (i = 0; i < intfd->bNumEndpoints; ++i) {
@@ -1944,3 +1968,5 @@
 EXPORT_SYMBOL(snd_usbmidi_input_stop);
 EXPORT_SYMBOL(snd_usbmidi_input_start);
 EXPORT_SYMBOL(snd_usbmidi_disconnect);
+
+#include "usbmidi.inc1"
