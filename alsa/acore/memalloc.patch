--- ../alsa-kernel/core/memalloc.c	2004-03-03 20:53:56.000000000 +0100
+++ memalloc.c	2004-03-05 00:44:35.895900880 +0100
@@ -1,3 +1,4 @@
+#include "memalloc.inc"
 /*
  *  Copyright (c) by Jaroslav Kysela <perex@suse.cz>
  *                   Takashi Iwai <tiwai@suse.de>
@@ -85,6 +86,7 @@
  *  Hacks
  */
 
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(2, 4, 0)
 #if defined(__i386__) || defined(__ppc__) || defined(__x86_64__)
 
 /*
@@ -135,6 +137,7 @@
 #define dma_alloc_coherent snd_dma_hack_alloc_coherent
 
 #endif /* arch */
+#endif /* >= 2.4.0 */
 
 /*
  *
@@ -462,7 +465,7 @@
 #endif
 #ifdef CONFIG_PCI
 	case SNDRV_DMA_TYPE_PCI:
-		dmab->area = snd_malloc_dev_pages(&dev->dev.pci->dev, size, &dmab->addr);
+		dmab->area = snd_malloc_dev_pages(snd_kdevice_pci(dev->dev.pci), size, &dmab->addr);
 		break;
 #endif
 	case SNDRV_DMA_TYPE_DEV:
@@ -523,7 +526,7 @@
 #endif
 #ifdef CONFIG_PCI
 	case SNDRV_DMA_TYPE_PCI:
-		dmab->area = snd_malloc_dev_pages_fallback(&dev->dev.pci->dev, size, &dmab->addr, &dmab->bytes);
+		dmab->area = snd_malloc_dev_pages_fallback(snd_kdevice_pci(dev->dev.pci), size, &dmab->addr, &dmab->bytes);
 		break;
 #endif
 	case SNDRV_DMA_TYPE_DEV:
@@ -570,7 +573,7 @@
 #endif
 #ifdef CONFIG_PCI
 	case SNDRV_DMA_TYPE_PCI:
-		snd_free_dev_pages(&dev->dev.pci->dev, dmab->bytes, dmab->area, dmab->addr);
+		snd_free_dev_pages(snd_kdevice_pci(dev->dev.pci), dmab->bytes, dmab->area, dmab->addr);
 		break;
 #endif
 	case SNDRV_DMA_TYPE_DEV:
@@ -725,6 +728,7 @@
 		kfree(mem);
 	}
 	up(&list_mutex);
+	snd_kdevice_free_all();
 }
 
 
@@ -772,7 +776,7 @@
 {
 	memset(dev, 0, sizeof(*dev));
 	dev->type = SNDRV_DMA_TYPE_DEV;
-	dev->dev.dev = &pci->dev;
+	dev->dev.dev = snd_kdevice_pci(pci);
 	dev->id = id;
 }
 
@@ -875,7 +879,11 @@
 			if (mem->dev.dev.dev) {
 				len += sprintf(page + len, "%s [%s]",
 					       mem->dev.type == SNDRV_DMA_TYPE_PCI_SG ? "PCI" : "PCI-SG",
-					       mem->dev.dev.pci->slot_name);
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(2, 5, 0)
+					       mem->dev.dev.pci->dev.bus_id);
+#else
+					       snd_pci_dev_name(mem->dev.dev.pci));
+#endif
 			}
 			break;
 #endif
@@ -884,7 +892,11 @@
 			if (mem->dev.dev.dev) {
 				len += sprintf(page + len, "%s [%s]",
 					       mem->dev.type == SNDRV_DMA_TYPE_DEV_SG ? "DEV" : "DEV-SG",
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(2, 5, 0)
 					       mem->dev.dev.dev->bus_id);
+#else
+					       snd_kdevice_busid(mem->dev.dev.dev));
+#endif
 			}
 			break;
 		default:
@@ -959,3 +971,5 @@
 EXPORT_SYMBOL(snd_malloc_pages);
 EXPORT_SYMBOL(snd_malloc_pages_fallback);
 EXPORT_SYMBOL(snd_free_pages);
+
+#include "memalloc.inc1"
