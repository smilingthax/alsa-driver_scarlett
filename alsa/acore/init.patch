--- ../alsa-kernel/core/init.c	2004-11-12 14:56:32.000000000 +0100
+++ init.c	2004-11-15 15:28:19.220049394 +0100
@@ -1,3 +1,4 @@
+#define __NO_VERSION__
 /*
  *  Initialization routines
  *  Copyright (c) by Jaroslav Kysela <perex@suse.cz>
@@ -196,7 +197,9 @@
 		f_ops = &s_f_ops->f_ops;
 
 		memset(f_ops, 0, sizeof(*f_ops));
+#ifndef LINUX_2_2
 		f_ops->owner = file->f_op->owner;
+#endif
 		f_ops->release = file->f_op->release;
 		f_ops->poll = snd_disconnect_poll;
 
@@ -779,6 +782,37 @@
 }
 
 #ifdef CONFIG_PCI
+#ifndef CONFIG_HAVE_PCI_SAVED_CONFIG
+static unsigned int pci_saved_config[SNDRV_CARDS][16];
+#endif
+#ifdef PCI_OLD_SUSPEND
+void snd_card_pci_suspend(struct pci_dev *dev)
+{
+	snd_card_t *card = pci_get_drvdata(dev);
+	if (! card || ! card->pm_suspend)
+		return;
+	if (card->power_state == SNDRV_CTL_POWER_D3hot)
+		return;
+	/* FIXME: correct state value? */
+	card->pm_suspend(card, 0);
+	pci_save_state(dev, &pci_saved_config[card->number][0]);
+}
+
+void snd_card_pci_resume(struct pci_dev *dev)
+{
+	snd_card_t *card = pci_get_drvdata(dev);
+	if (! card || ! card->pm_resume)
+		return;
+	if (card->power_state == SNDRV_CTL_POWER_D0)
+		return;
+	/* restore the PCI config space */
+	pci_restore_state(dev, &pci_saved_config[card->number][0]);
+	/* FIXME: correct state value? */
+	card->pm_resume(card, 0);
+}
+
+#else /* new suspend */
+
 int snd_card_pci_suspend(struct pci_dev *dev, u32 state)
 {
 	snd_card_t *card = pci_get_drvdata(dev);
@@ -789,7 +823,11 @@
 		return 0;
 	/* FIXME: correct state value? */
 	err = card->pm_suspend(card, 0);
+#ifndef CONFIG_HAVE_PCI_SAVED_CONFIG
+	pci_save_state(dev, &pci_saved_config[card->number][0]);
+#elif LINUX_VERSION_CODE >= KERNEL_VERSION(2, 6, 10)
 	pci_save_state(dev);
+#endif
 	return err;
 }
 
@@ -801,10 +839,18 @@
 	if (card->power_state == SNDRV_CTL_POWER_D0)
 		return 0;
 	/* restore the PCI config space */
+#ifndef CONFIG_HAVE_PCI_SAVED_CONFIG
+	pci_restore_state(dev, &pci_saved_config[card->number][0]);
+#elif defined(CONFIG_HAVE_NEW_PCI_SAVE_STATE)
 	pci_restore_state(dev);
+#else
+ 	pci_restore_state(dev, dev->saved_config_space);
+#endif
 	/* FIXME: correct state value? */
 	return card->pm_resume(card, 0);
 }
-#endif
+
+#endif /* PCI_OLD_SUSPEND */
+#endif /* CONFIG_PCI */
 
 #endif /* CONFIG_PM */
