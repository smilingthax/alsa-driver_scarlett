--- ../alsa-kernel/core/init.c	2005-11-14 15:43:24.000000000 +0100
+++ init.c	2005-11-14 15:49:47.000000000 +0100
@@ -1,3 +1,4 @@
+#define __NO_VERSION__
 /*
  *  Initialization routines
  *  Copyright (c) by Jaroslav Kysela <perex@suse.cz>
@@ -196,7 +197,9 @@
 		f_ops = &s_f_ops->f_ops;
 
 		memset(f_ops, 0, sizeof(*f_ops));
+#ifndef LINUX_2_2
 		f_ops->owner = file->f_op->owner;
+#endif
 		f_ops->release = file->f_op->release;
 		f_ops->poll = snd_disconnect_poll;
 
@@ -667,6 +670,7 @@
 }
 
 #ifdef CONFIG_SND_GENERIC_DRIVER
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(2, 6, 0)
 /*
  * generic device without a proper bus using platform_device
  * (e.g. ISA)
@@ -755,6 +759,24 @@
 		snd_card_set_dev(card, &card->generic_dev->pdev.dev);
 	return 0;
 }
+#else /* < 2.6.0 */
+
+int snd_card_set_generic_dev(struct snd_card *card)
+{
+	return 0;
+}
+
+static void snd_generic_device_unregister(struct snd_card *card)
+{
+#ifdef CONFIG_PM
+	if (card->generic_dev) {
+		pm_unregister((struct pm_dev *)card->generic_dev);
+		card->generic_dev = NULL;
+	}
+#endif
+}
+
+#endif /* 2.6.0 */
 #endif /* CONFIG_SND_GENERIC_DRIVER */
 
 #ifdef CONFIG_PM
@@ -823,6 +845,7 @@
 }
 
 #ifdef CONFIG_SND_GENERIC_DRIVER
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(2, 6, 0)
 /* suspend/resume callbacks for snd_generic platform device */
 static int snd_generic_suspend(struct platform_device *dev, pm_message_t state)
 {
@@ -871,9 +894,83 @@
 		return err;
 	return snd_card_set_pm_callback(card, suspend, resume, private_data);
 }
+
+#else /* 2.4.x */
+
+static int snd_generic_pm_callback(struct pm_dev *dev, pm_request_t rqst, void *data)
+{
+	struct snd_card *card = dev->data;
+	switch (rqst) {
+	case PM_SUSPEND:
+		if (card->power_state == SNDRV_CTL_POWER_D3hot)
+			break;
+		/* FIXME: the correct state value? */
+		card->pm_suspend(card, PMSG_SUSPEND);
+		snd_power_change_state(card, SNDRV_CTL_POWER_D3hot);
+		break;
+	case PM_RESUME:
+		if (card->power_state == SNDRV_CTL_POWER_D0)
+			break;
+		/* FIXME: the correct state value? */
+		card->pm_resume(card);
+		snd_power_change_state(card, SNDRV_CTL_POWER_D0);
+		break;
+	}
+	return 0;
+}
+
+int snd_card_set_generic_pm_callback(struct snd_card *card,
+				 int (*suspend)(struct snd_card *, pm_message_t),
+				 int (*resume)(struct snd_card *),
+				 void *private_data)
+{
+	struct pm_dev *pm_dev;
+
+	pm_dev = pm_register(PM_UNKNOWN_DEV, 0, snd_generic_pm_callback);
+	if (! pm_dev)
+		return -ENOMEM;
+	pm_dev->data = card;
+	card->generic_dev = (struct snd_generic_device *)pm_dev;
+	snd_card_set_pm_callback(card, suspend, resume, private_data);
+	return 0;
+}
+#endif /* 2.6.0 */
 #endif /* CONFIG_SND_GENERIC_DRIVER */
 
 #ifdef CONFIG_PCI
+#ifndef CONFIG_HAVE_PCI_SAVED_CONFIG
+static unsigned int pci_saved_config[SNDRV_CARDS][16];
+#endif
+#ifdef PCI_OLD_SUSPEND
+void snd_card_pci_suspend(struct pci_dev *dev)
+{
+	struct snd_card *card = pci_get_drvdata(dev);
+	if (! card || ! card->pm_suspend)
+		return;
+	if (card->power_state == SNDRV_CTL_POWER_D3hot)
+		return;
+	/* FIXME: correct state value? */
+	card->pm_suspend(card, PMSG_SUSPEND);
+	pci_save_state(dev, &pci_saved_config[card->number][0]);
+	snd_power_change_state(card, SNDRV_CTL_POWER_D3hot);
+}
+
+void snd_card_pci_resume(struct pci_dev *dev)
+{
+	struct snd_card *card = pci_get_drvdata(dev);
+	if (! card || ! card->pm_resume)
+		return;
+	if (card->power_state == SNDRV_CTL_POWER_D0)
+		return;
+	/* restore the PCI config space */
+	pci_restore_state(dev, &pci_saved_config[card->number][0]);
+	/* FIXME: correct state value? */
+	card->pm_resume(card);
+	snd_power_change_state(card, SNDRV_CTL_POWER_D0);
+}
+
+#else /* new suspend */
+
 int snd_card_pci_suspend(struct pci_dev *dev, pm_message_t state)
 {
 	struct snd_card *card = pci_get_drvdata(dev);
@@ -883,7 +980,11 @@
 	if (card->power_state == SNDRV_CTL_POWER_D3hot)
 		return 0;
 	err = card->pm_suspend(card, PMSG_SUSPEND);
+#ifndef CONFIG_HAVE_PCI_SAVED_CONFIG
+	pci_save_state(dev, &pci_saved_config[card->number][0]);
+#elif LINUX_VERSION_CODE >= KERNEL_VERSION(2, 6, 10)
 	pci_save_state(dev);
+#endif
 	snd_power_change_state(card, SNDRV_CTL_POWER_D3hot);
 	return err;
 }
@@ -896,11 +997,19 @@
 	if (card->power_state == SNDRV_CTL_POWER_D0)
 		return 0;
 	/* restore the PCI config space */
+#ifndef CONFIG_HAVE_PCI_SAVED_CONFIG
+	pci_restore_state(dev, &pci_saved_config[card->number][0]);
+#elif defined(CONFIG_HAVE_NEW_PCI_SAVE_STATE)
 	pci_restore_state(dev);
+#else
+ 	pci_restore_state(dev, dev->saved_config_space);
+#endif
 	card->pm_resume(card);
 	snd_power_change_state(card, SNDRV_CTL_POWER_D0);
 	return 0;
 }
-#endif
+
+#endif /* PCI_OLD_SUSPEND */
+#endif /* CONFIG_PCI */
 
 #endif /* CONFIG_PM */
